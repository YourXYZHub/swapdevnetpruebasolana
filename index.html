<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Meteora (Devnet) · DBC & DAMM2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 860px }
    input, button, select { padding: 10px; font-size: 16px; margin: 6px 0; width: 100% }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px }
    .muted { color: #666; font-size: 14px }
    .ok { color: #0a7 }
    .err { color: #c33 }
    pre { background: #f6f6f6; padding: 12px; border-radius: 8px; overflow-x: auto; max-height: 300px }
    small { color:#555 }
  </style>
</head>
<body>
  <h1>Meteora Devnet · Trade SOL ↔ TOKEN</h1>
  <p class="muted">Selecciona protocolo y rellena los campos. Conecta Phantom en <b>Devnet</b>.</p>

  <div class="row">
    <div>
      <label>Protocolo</label>
      <select id="protocol">
        <option value="dbc">DBC (antes de migrar)</option>
        <option value="damm2">DAMM2 (después de migrar)</option>
      </select>
    </div>
    <div>
      <button id="connect">Conectar Phantom</button>
      <div id="wallet" class="muted"></div>
    </div>
  </div>

  <h3>Parámetros</h3>
  <div class="row">
    <div>
      <label>Pool (PDA)</label>
      <input id="pool" placeholder="Para DAMM2 es requerido" />
    </div>
    <div>
      <label>baseMint (solo DBC: SOL→TOKEN)</label>
      <input id="baseMint" placeholder="Opcional si pones pool (DBC)" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>Monto en SOL (comprar)</label>
      <input id="amountSol" type="number" step="0.0001" placeholder="0.05" />
    </div>
    <div>
      <label>Cant. TOKEN (vender, unidades mínimas)</label>
      <input id="amountTokens" type="number" step="1" placeholder="100000" />
      <small>Ojo con los <i>decimals</i> del token.</small>
    </div>
  </div>

  <div class="row">
    <button id="checkBtn">Comprobar estado</button>
    <button id="quoteBtn">Quote compra</button>
  </div>

  <div class="row">
    <button id="buyBtn">Comprar (SOL→TOKEN)</button>
    <button id="sellBtn">Vender (TOKEN→SOL)</button>
  </div>

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script>
    // ===== CONFIG =====
    const BACKEND_URL = "https://TU_BACKEND_RAILWAY_AQUI"; // <-- CAMBIA ESTO
    const DEVNET_RPC = "https://api.devnet.solana.com";

    const $ = (id) => document.getElementById(id)
    const addLog = (msg, cls='muted') => {
      const l=document.createElement('div'); l.className=cls; l.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      $('log').prepend(l); console.log(msg)
    }
    const proto = () => $('protocol').value

    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts)
      const text = await r.text()
      try { return { ok: r.ok, data: JSON.parse(text) } }
      catch (e) { throw new Error(`No-JSON ${r.status}: ${text.slice(0,160)}`) }
    }

    let provider = null
    let walletPubkey = null
    let conn = null

    document.addEventListener('DOMContentLoaded', () => {
      if (!window.solana || !window.solana.isPhantom) addLog('Phantom no detectado', 'err')
      else { provider = window.solana; addLog('Phantom detectado ✅','ok') }
      conn = new solanaWeb3.Connection(DEVNET_RPC, 'confirmed'); addLog('Conexión Devnet lista', 'ok')
    })

    $('connect').onclick = async () => {
      try {
        if (!provider) return addLog('Phantom no está disponible', 'err')
        try { await provider.request({ method: 'wallet_switchSolanaNetwork', params: { network: 'devnet' } }) } catch {}
        const r = await provider.connect({ onlyIfTrusted:false })
        walletPubkey = (r.publicKey || provider.publicKey).toString()
        $('wallet').textContent = `Conectado: ${walletPubkey}`
        addLog('Wallet conectada', 'ok')
      } catch (e) { addLog('Connect cancelado: ' + (e.message || e), 'err') }
    }

    async function signSend(rawB64) {
      const raw = Uint8Array.from(atob(rawB64), c => c.charCodeAt(0))
      let tx
      try { tx = solanaWeb3.VersionedTransaction.deserialize(raw); addLog('TX versioned deserializada','ok') }
      catch { tx = solanaWeb3.Transaction.from(raw); addLog('TX legacy deserializada','ok') }

      try {
        const sigResp = await provider.signAndSendTransaction(tx)
        const signature = sigResp.signature || sigResp
        addLog('Tx enviada: ' + signature, 'ok')
        const conf = await conn.confirmTransaction(signature, 'confirmed')
        if (conf?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf.value.err), 'err')
        else addLog('Confirmada ✅ ' + signature, 'ok')
      } catch (e1) {
        addLog('Fallback signTransaction → sendRaw', 'muted')
        const signed = await provider.signTransaction(tx)
        const rawSigned = signed.serialize ? signed.serialize() : signed
        const sig = await conn.sendRawTransaction(rawSigned, { skipPreflight: false })
        addLog('Tx enviada (fallback): ' + sig, 'ok')
        const conf2 = await conn.confirmTransaction(sig, 'confirmed')
        if (conf2?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf2.value.err), 'err')
        else addLog('Confirmada ✅ ' + sig, 'ok')
      }
    }

    // ===== Botones =====
    $('checkBtn').onclick = async () => {
      try {
        const pool = $('pool').value.trim()
        const baseMint = $('baseMint').value.trim()
        if (proto()==='dbc') {
          if (!pool && !baseMint) return addLog('DBC: pool o baseMint requerido','err')
          const qs = new URLSearchParams({})
          if (pool) qs.set('pool', pool)
          if (baseMint) qs.set('baseMint', baseMint)
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/dbc/resolve?${qs.toString()}`)
          if (!ok) throw new Error(data?.error || 'resolve DBC falló')
          if (!$('pool').value && data.pool) $('pool').value = data.pool
          addLog(`DBC OK · pool=${data.pool} · completed=${data.isCompleted}`, data.isCompleted?'err':'ok')
        } else {
          if (!pool) return addLog('DAMM2: pool requerido','err')
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/damm2/status?pool=${pool}`)
          if (!ok) throw new Error(data?.error || 'status DAMM2 falló')
          addLog(`DAMM2 OK · tokenA=${data.tokenA} · tokenB=${data.tokenB} · wsol=${data.supportsWSOL}`, 'ok')
        }
      } catch (e) { addLog('Estado error: ' + (e.message || e), 'err') }
    }

    $('quoteBtn').onclick = async () => {
      try {
        const pool = $('pool').value.trim()
        const baseMint = $('baseMint').value.trim()
        const amountSol = $('amountSol').value.trim()
        if (proto()==='dbc') {
          if (!amountSol) return addLog('DBC: amountSol requerido', 'err')
          const qs = new URLSearchParams({ amountSol })
          if (pool) qs.set('pool', pool)
          if (!pool && baseMint) qs.set('baseMint', baseMint)
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/dbc/quote?${qs.toString()}`)
          if (!ok) {
            if (data?.code === 'MIGRATED_TO_DAMM_V2') addLog('DBC migrado → usa DAMM2', 'err')
            else addLog('Quote DBC error: ' + (data?.error || 'falló'), 'err')
            return
          }
          addLog(`Quote DBC OK · in=${data.amountInLamports} · minOut=${data.minimumAmountOut}`, 'ok')
        } else {
          if (!pool || !amountSol) return addLog('DAMM2: pool y amountSol requeridos', 'err')
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/damm2/quote?pool=${pool}&side=buy&amount=${amountSol}`)
          if (!ok) return addLog('Quote DAMM2 error: ' + (data?.error || 'falló'), 'err')
          addLog(`Quote DAMM2 OK · minOut=${data.minSwapOutAmount}`, 'ok')
        }
      } catch (e) { addLog('Quote error: ' + (e.message || e), 'err') }
    }

    $('buyBtn').onclick = async () => {
      try {
        if (!provider || !walletPubkey) return addLog('Conecta Phantom primero','err')
        const pool = $('pool').value.trim()
        const baseMint = $('baseMint').value.trim()
        const amountSol = $('amountSol').value.trim()
        if (!amountSol) return addLog('amountSol requerido','err')

        if (proto()==='dbc') {
          const body = { buyer: walletPubkey, amountSol }
          if (pool) body.pool = pool
          if (!pool && baseMint) body.baseMint = baseMint
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/dbc/build-buy`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
          })
          if (!ok) {
            if (data?.code === 'MIGRATED_TO_DAMM_V2') addLog('DBC migrado → usa DAMM2', 'err')
            else addLog('Construcción DBC falló: ' + (data?.error || 'desconocido'), 'err')
            return
          }
          await signSend(data.transaction)
        } else {
          if (!pool) return addLog('DAMM2: pool requerido','err')
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/damm2/build-swap`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pool, payer: walletPubkey, side: 'buy', amount: amountSol }),
          })
          if (!ok) return addLog('build-swap DAMM2 falló: ' + (data?.error || 'desconocido'), 'err')
          await signSend(data.transaction)
        }
      } catch (e) { addLog('Compra error: ' + (e.message || e), 'err') }
    }

    $('sellBtn').onclick = async () => {
      try {
        if (!provider || !walletPubkey) return addLog('Conecta Phantom primero','err')
        const pool = $('pool').value.trim()
        const amountTokens = $('amountTokens').value.trim()
        if (!amountTokens) return addLog('amountTokens requerido','err')

        if (proto()==='dbc') {
          if (!pool) return addLog('DBC: pool requerido para vender','err')
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/dbc/build-sell`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pool, seller: walletPubkey, amountTokens }),
          })
          if (!ok) return addLog('build-sell DBC falló: ' + (data?.error || 'desconocido'), 'err')
          await signSend(data.transaction)
        } else {
          if (!pool) return addLog('DAMM2: pool requerido','err')
          const { ok, data } = await fetchJSON(`${BACKEND_URL}/damm2/build-swap`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pool, payer: walletPubkey, side: 'sell', amount: amountTokens }),
          })
          if (!ok) return addLog('build-swap DAMM2 falló: ' + (data?.error || 'desconocido'), 'err')
          await signSend(data.transaction)
        }
      } catch (e) { addLog('Venta error: ' + (e.message || e), 'err') }
    }
  </script>
</body>
</html>
