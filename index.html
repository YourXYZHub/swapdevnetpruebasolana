<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Compra Token (Devnet)</title>
</head>
<body>
  <button id="connect">Conectar Phantom</button>
  <p id="wallet"></p>

  <input id="pool" placeholder="Pool PDA">
  <input id="baseMint" placeholder="Base Mint">
  <input id="amountSol" placeholder="Monto en SOL">

  <button id="buy">Comprar</button>

  <pre id="log"></pre>

  <script type="module">
    import { Connection, VersionedTransaction } from "https://esm.sh/@solana/web3.js@1.95.3"
    const BACKEND = "https://comprartokendevnetbackend-production.up.railway.app"  // ajusta a tu backend

    let wallet = null
    const conn = new Connection("https://api.devnet.solana.com", "confirmed")

    document.getElementById("connect").onclick = async () => {
      const provider = window.solana
      const r = await provider.connect()
      wallet = r.publicKey.toString()
      document.getElementById("wallet").textContent = "Wallet: " + wallet
    }

    document.getElementById("buy").onclick = async () => {
      const pool = document.getElementById("pool").value
      const baseMint = document.getElementById("baseMint").value
      const amountSol = document.getElementById("amountSol").value
      const body = { buyer: wallet, amountSol }
      if (pool) body.pool = pool
      if (baseMint) body.baseMint = baseMint

      const r = await fetch(`${BACKEND}/build-initial-buy`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      })
      const j = await r.json()
      const txBytes = Uint8Array.from(atob(j.transaction), c => c.charCodeAt(0))
      const tx = VersionedTransaction.deserialize(txBytes)

      const sig = await window.solana.signAndSendTransaction(tx)
      document.getElementById("log").textContent = "Tx enviada: " + JSON.stringify(sig)
    }
  </script>
</body>
</html>
