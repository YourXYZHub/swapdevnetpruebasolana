<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Swap DBC Devnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Carga IIFE de web3.js (global: solanaWeb3). Evita módulos/ESM. -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 760px }
    input, button { padding: 10px; font-size: 16px; margin: 6px 0; width: 100% }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px }
    .muted { color: #666; font-size: 14px }
    .ok { color: #0a7 }
    .err { color: #c33 }
    pre { background: #f6f6f6; padding: 12px; border-radius: 8px; overflow-x: auto; max-height: 240px }
  </style>
</head>
<body>
  <h1>Swap SOL → TOKEN (Meteora DBC · Devnet)</h1>
  <p class="muted">Conecta Phantom en <b>Devnet</b>, indica <b>pool</b> o <b>baseMint</b> y un monto en SOL.</p>

  <button id="connect">Conectar Phantom</button>
  <div id="wallet" class="muted"></div>

  <h3>Datos</h3>
  <div class="row">
    <div>
      <label>Pool (PDA)</label>
      <input id="pool" placeholder="Opcional si pones baseMint" />
    </div>
    <div>
      <label>baseMint (SOL→TOKEN)</label>
      <input id="baseMint" placeholder="Opcional si pones pool" />
    </div>
  </div>

  <label>Monto en SOL</label>
  <input id="amountSol" type="number" step="0.0001" placeholder="0.05" />

  <div class="row">
    <button id="quoteBtn">Ver Quote</button>
    <button id="buyBtn">Comprar</button>
  </div>

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script>
    // ===== CONFIG =====
    const BACKEND_URL = "https://comprartokendevnetbackend-production.up.railway.app"; // <-- tu backend
    const DEVNET_RPC = "https://api.devnet.solana.com";

    // ===== UTIL =====
    const $ = (id) => document.getElementById(id);
    const addLog = (msg, cls='muted') => {
      const line = document.createElement('div');
      line.className = cls;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      const pre = $('log');
      pre.prepend(line);
      console.log(msg);
    };

    // ===== ESTADO =====
    let provider = null;
    let walletPubkey = null;
    let conn = null;

    // ===== ARRANQUE =====
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          addLog('Phantom no detectado. Instálalo o habilítalo en esta página.', 'err');
        } else {
          provider = window.solana;
          addLog('Phantom detectado ✅', 'ok');
        }
        conn = new solanaWeb3.Connection(DEVNET_RPC, 'confirmed');
        addLog('Conexión Devnet lista', 'ok');
      } catch (e) {
        addLog('Error inicializando: ' + (e.message || e), 'err');
      }
    });

    // ===== HANDLERS =====
    $('connect').onclick = async () => {
      try {
        if (!provider) {
          addLog('Phantom no está disponible', 'err');
          return;
        }
        // Intentar forzar Devnet si la wallet lo soporta
        try { await provider.request({ method: 'wallet_switchSolanaNetwork', params: { network: 'devnet' } }); } catch (_) {}

        const resp = await provider.connect({ onlyIfTrusted: false });
        walletPubkey = (resp.publicKey || provider.publicKey).toString();
        $('wallet').textContent = `Conectado: ${walletPubkey}`;
        addLog('Wallet conectada', 'ok');
      } catch (e) {
        addLog('Connect cancelado o falló: ' + (e.message || e), 'err');
      }
    };

    $('quoteBtn').onclick = async () => {
      try {
        const pool = $('pool').value.trim();
        const baseMint = $('baseMint').value.trim();
        const amountSol = $('amountSol').value.trim();
        if (!amountSol) return addLog('amountSol requerido', 'err');
        if (!pool && !baseMint) return addLog('pool o baseMint requerido', 'err');

        const qs = new URLSearchParams({ amountSol });
        if (pool) qs.set('pool', pool);
        if (baseMint) qs.set('baseMint', baseMint);

        addLog('Pidiendo quote…');
        const r = await fetch(`${BACKEND_URL}/quote?${qs.toString()}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Quote falló');
        addLog(`Quote OK · amountIn=${j.amountInLamports} · minOut=${j.minimumAmountOut}`, 'ok');
      } catch (e) {
        addLog('Quote error: ' + (e.message || e), 'err');
      }
    };

    $('buyBtn').onclick = async () => {
      try {
        if (!provider || !walletPubkey) return addLog('Conecta Phantom primero', 'err');

        const pool = $('pool').value.trim();
        const baseMint = $('baseMint').value.trim();
        const amountSol = $('amountSol').value.trim();
        if (!amountSol) return addLog('amountSol requerido', 'err');
        if (!pool && !baseMint) return addLog('pool o baseMint requerido', 'err');

        const body = { buyer: walletPubkey, amountSol };
        if (pool) body.pool = pool;
        if (baseMint) body.baseMint = baseMint;

        addLog('Construyendo transacción en backend…');
        const r = await fetch(`${BACKEND_URL}/build-initial-buy`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Construcción falló');

        const raw = Uint8Array.from(atob(j.transaction), c => c.charCodeAt(0));

        // Deserializa como Versioned, si falla prueba Legacy
        let tx;
        try {
          tx = solanaWeb3.VersionedTransaction.deserialize(raw);
          addLog('TX versioned deserializada', 'ok');
        } catch {
          tx = solanaWeb3.Transaction.from(raw);
          addLog('TX legacy deserializada', 'ok');
        }

        // 1) Intento directo con signAndSendTransaction
        try {
          const sigResp = await provider.signAndSendTransaction(tx);
          const signature = sigResp.signature || sigResp;
          addLog('Tx enviada: ' + signature, 'ok');
          const conf = await conn.confirmTransaction(signature, 'confirmed');
          if (conf?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf.value.err), 'err');
          else addLog('Confirmada ✅ ' + signature, 'ok');
          return;
        } catch (e1) {
          addLog('signAndSendTransaction falló, uso fallback: ' + (e1.message || e1), 'muted');
        }

        // 2) Fallback: firmar y enviar manualmente
        const signed = await provider.signTransaction(tx);
        const rawSigned = signed.serialize ? signed.serialize() : signed;
        const sig = await conn.sendRawTransaction(rawSigned, { skipPreflight: false });
        addLog('Tx enviada (fallback): ' + sig, 'ok');
        const conf2 = await conn.confirmTransaction(sig, 'confirmed');
        if (conf2?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf2.value.err), 'err');
        else addLog('Confirmada ✅ ' + sig, 'ok');

      } catch (e) {
        addLog('Compra error: ' + (e.message || e), 'err');
      }
    };
  </script>
</body>
</html>
