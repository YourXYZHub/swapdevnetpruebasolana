<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Swap DBC Devnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 760px }
    input, button, select { padding: 10px; font-size: 16px; margin: 6px 0; width: 100% }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px }
    .muted { color: #666; font-size: 14px }
    .ok { color: #0a7 }
    .err { color: #c33 }
    pre { background: #f6f6f6; padding: 12px; border-radius: 8px; overflow-x: auto; max-height: 240px }
    .tab { display: flex; gap: 10px; margin: 20px 0; }
    .tab button { flex: 1; padding: 10px; border: 1px solid #ccc; background: white; cursor: pointer; }
    .tab button.active { background: #007cba; color: white; }
    .tabcontent { display: none; }
    .tabcontent.active { display: block; }
  </style>
</head>
<body>
  <h1>Swap SOL → TOKEN (Meteora DBC · Devnet)</h1>
  <p class="muted">Conecta Phantom en <b>Devnet</b>, indica <b>pool</b> o <b>baseMint</b> y un monto en SOL.</p>

  <button id="connect">Conectar Phantom</button>
  <div id="wallet" class="muted"></div>

  <div class="tab">
    <button class="tab-btn active" data-tab="buy">Comprar Tokens</button>
    <button class="tab-btn" data-tab="sell">Vender Tokens</button>
    <button class="tab-btn" data-tab="tools">Herramientas</button>
  </div>

  <!-- TAB COMPRAR -->
  <div id="buy" class="tabcontent active">
    <h3>Comprar Tokens (SOL → TOKEN)</h3>
    
    <div class="row">
      <div>
        <label>Pool (PDA)</label>
        <input id="pool" placeholder="Opcional si pones baseMint" />
      </div>
      <div>
        <label>baseMint (SOL→TOKEN)</label>
        <input id="baseMint" placeholder="Opcional si pones pool" />
      </div>
    </div>

    <label>Monto en SOL</label>
    <input id="amountSol" type="number" step="0.0001" placeholder="0.05" />

    <div class="row">
      <button id="quoteBtn">Ver Quote</button>
      <button id="buyBtn">Comprar Tokens</button>
    </div>
  </div>

  <!-- TAB VENDER -->
  <div id="sell" class="tabcontent">
    <h3>Vender Tokens (TOKEN → SOL)</h3>
    
    <div class="row">
      <div>
        <label>Pool (PDA)</label>
        <input id="sellPool" placeholder="Opcional si pones quoteMint" />
      </div>
      <div>
        <label>quoteMint (TOKEN→SOL)</label>
        <input id="quoteMint" placeholder="Opcional si pones pool" />
      </div>
    </div>

    <label>Monto en Tokens</label>
    <input id="amountTokens" type="number" step="0.0001" placeholder="100" />

    <div class="row">
      <button id="sellQuoteBtn">Ver Quote Venta</button>
      <button id="sellBtn">Vender Tokens</button>
    </div>
  </div>

  <!-- TAB HERRAMIENTAS -->
  <div id="tools" class="tabcontent">
    <h3>Herramientas</h3>
    
    <button id="findPoolsBtn">Buscar Pools Activos</button>
    <button id="healthBtn">Verificar Salud Backend</button>
    
    <div id="toolsResult" style="margin-top: 20px;"></div>
  </div>

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script>
    // ===== CONFIG =====
    const BACKEND_URL = "https://comprartokendevnetbackend-production.up.railway.app";
    const DEVNET_RPC = "https://api.devnet.solana.com";

    // ===== UTIL =====
    const $ = (id) => document.getElementById(id);
    const addLog = (msg, cls='muted') => {
      const line = document.createElement('div');
      line.className = cls;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      const pre = $('log');
      pre.prepend(line);
      console.log(msg);
    };

    // ===== ESTADO =====
    let provider = null;
    let walletPubkey = null;
    let conn = null;

    // ===== TABS =====
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tabcontent').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        $(btn.dataset.tab).classList.add('active');
      });
    });

    // ===== ARRANQUE =====
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          addLog('Phantom no detectado. Instálalo o habilítalo en esta página.', 'err');
        } else {
          provider = window.solana;
          addLog('Phantom detectado ✅', 'ok');
        }
        conn = new solanaWeb3.Connection(DEVNET_RPC, 'confirmed');
        addLog('Conexión Devnet lista', 'ok');
      } catch (e) {
        addLog('Error inicializando: ' + (e.message || e), 'err');
      }
    });

    // ===== WALLET =====
    $('connect').onclick = async () => {
      try {
        if (!provider) {
          addLog('Phantom no está disponible', 'err');
          return;
        }
        
        try { 
          await provider.request({ method: 'wallet_switchSolanaNetwork', params: { network: 'devnet' } }); 
        } catch (_) {}

        const resp = await provider.connect({ onlyIfTrusted: false });
        walletPubkey = (resp.publicKey || provider.publicKey).toString();
        $('wallet').textContent = `Conectado: ${walletPubkey}`;
        addLog('Wallet conectada', 'ok');
      } catch (e) {
        addLog('Connect cancelado o falló: ' + (e.message || e), 'err');
      }
    };

    // ===== COMPRAR =====
    $('quoteBtn').onclick = async () => {
      try {
        const pool = $('pool').value.trim();
        const baseMint = $('baseMint').value.trim();
        const amountSol = $('amountSol').value.trim();
        if (!amountSol) return addLog('amountSol requerido', 'err');
        if (!pool && !baseMint) return addLog('pool o baseMint requerido', 'err');

        const qs = new URLSearchParams({ amountSol });
        if (pool) qs.set('pool', pool);
        if (baseMint) qs.set('baseMint', baseMint);

        addLog('Pidiendo quote compra...');
        const r = await fetch(`${BACKEND_URL}/quote?${qs.toString()}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Quote falló');
        addLog(`Quote OK · SOL: ${amountSol} → Min tokens: ${j.minimumAmountOut}`, 'ok');
      } catch (e) {
        addLog('Quote error: ' + (e.message || e), 'err');
      }
    };

    $('buyBtn').onclick = async () => {
      try {
        if (!provider || !walletPubkey) return addLog('Conecta Phantom primero', 'err');

        const pool = $('pool').value.trim();
        const baseMint = $('baseMint').value.trim();
        const amountSol = $('amountSol').value.trim();
        if (!amountSol) return addLog('amountSol requerido', 'err');
        if (!pool && !baseMint) return addLog('pool o baseMint requerido', 'err');

        const body = { buyer: walletPubkey, amountSol };
        if (pool) body.pool = pool;
        if (baseMint) body.baseMint = baseMint;

        addLog('Construyendo transacción de compra...');
        const r = await fetch(`${BACKEND_URL}/build-initial-buy`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Construcción falló');

        const raw = Uint8Array.from(atob(j.transaction), c => c.charCodeAt(0));

        let tx;
        try {
          tx = solanaWeb3.VersionedTransaction.deserialize(raw);
          addLog('TX versioned deserializada', 'ok');
        } catch {
          tx = solanaWeb3.Transaction.from(raw);
          addLog('TX legacy deserializada', 'ok');
        }

        // 1) Intento directo
        try {
          const sigResp = await provider.signAndSendTransaction(tx);
          const signature = sigResp.signature || sigResp;
          addLog('Tx enviada: ' + signature, 'ok');
          const conf = await conn.confirmTransaction(signature, 'confirmed');
          if (conf?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf.value.err), 'err');
          else addLog('Confirmada ✅ ' + signature, 'ok');
          return;
        } catch (e1) {
          addLog('signAndSendTransaction falló, uso fallback: ' + (e1.message || e1), 'muted');
        }

        // 2) Fallback
        const signed = await provider.signTransaction(tx);
        const rawSigned = signed.serialize ? signed.serialize() : signed;
        const sig = await conn.sendRawTransaction(rawSigned, { skipPreflight: false });
        addLog('Tx enviada (fallback): ' + sig, 'ok');
        const conf2 = await conn.confirmTransaction(sig, 'confirmed');
        if (conf2?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf2.value.err), 'err');
        else addLog('Confirmada ✅ ' + sig, 'ok');

      } catch (e) {
        addLog('Compra error: ' + (e.message || e), 'err');
      }
    };

    // ===== VENDER =====
    $('sellQuoteBtn').onclick = async () => {
      try {
        const pool = $('sellPool').value.trim();
        const quoteMint = $('quoteMint').value.trim();
        const amountTokens = $('amountTokens').value.trim();
        if (!amountTokens) return addLog('amountTokens requerido', 'err');
        if (!pool && !quoteMint) return addLog('pool o quoteMint requerido', 'err');

        addLog('Quote venta no implementado en backend', 'muted');
      } catch (e) {
        addLog('Quote venta error: ' + (e.message || e), 'err');
      }
    };

    $('sellBtn').onclick = async () => {
      try {
        if (!provider || !walletPubkey) return addLog('Conecta Phantom primero', 'err');

        const pool = $('sellPool').value.trim();
        const quoteMint = $('quoteMint').value.trim();
        const amountTokens = $('amountTokens').value.trim();
        if (!amountTokens) return addLog('amountTokens requerido', 'err');
        if (!pool && !quoteMint) return addLog('pool o quoteMint requerido', 'err');

        const body = { seller: walletPubkey, amountTokens };
        if (pool) body.pool = pool;
        if (quoteMint) body.quoteMint = quoteMint;

        addLog('Construyendo transacción de venta...');
        const r = await fetch(`${BACKEND_URL}/build-sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Construcción falló');

        const raw = Uint8Array.from(atob(j.transaction), c => c.charCodeAt(0));

        let tx;
        try {
          tx = solanaWeb3.VersionedTransaction.deserialize(raw);
          addLog('TX versioned deserializada', 'ok');
        } catch {
          tx = solanaWeb3.Transaction.from(raw);
          addLog('TX legacy deserializada', 'ok');
        }

        try {
          const sigResp = await provider.signAndSendTransaction(tx);
          const signature = sigResp.signature || sigResp;
          addLog('Tx venta enviada: ' + signature, 'ok');
          const conf = await conn.confirmTransaction(signature, 'confirmed');
          if (conf?.value?.err) addLog('Confirmación con error: ' + JSON.stringify(conf.value.err), 'err');
          else addLog('Venta Confirmada ✅ ' + signature, 'ok');
        } catch (e1) {
          addLog('Venta falló: ' + (e1.message || e1), 'err');
        }

      } catch (e) {
        addLog('Venta error: ' + (e.message || e), 'err');
      }
    };

    // ===== HERRAMIENTAS =====
    $('findPoolsBtn').onclick = async () => {
      try {
        addLog('Buscando pools activos...');
        const r = await fetch(`${BACKEND_URL}/active-pools`);
        const j = await r.json();
        
        if (!r.ok) throw new Error(j?.error || 'Búsqueda falló');
        
        const toolsResult = $('toolsResult');
        toolsResult.innerHTML = '';
        
        if (j.activePools && j.activePools.length > 0) {
          j.activePools.forEach(pool => {
            const div = document.createElement('div');
            div.innerHTML = `<strong>Pool:</strong> ${pool.address}<br>
                            <strong>Base:</strong> ${pool.baseMint}<br>
                            <strong>Quote:</strong> ${pool.quoteMint}<br>
                            <strong>Estado:</strong> ${pool.isCompleted ? 'COMPLETADO' : 'ACTIVO'}<br>`;
            toolsResult.appendChild(div);
          });
          addLog(`Encontrados ${j.activePools.length} pools activos`, 'ok');
        } else {
          toolsResult.innerHTML = 'No se encontraron pools activos';
          addLog('No se encontraron pools activos', 'err');
        }
      } catch (e) {
        addLog('Error buscando pools: ' + e.message, 'err');
      }
    };

    $('healthBtn').onclick = async () => {
      try {
        const r = await fetch(`${BACKEND_URL}/health`);
        const j = await r.json();
        $('toolsResult').innerHTML = `Backend: ${j.ok ? '✅ OK' : '❌ ERROR'}`;
        addLog(`Health check: ${j.ok ? 'OK' : 'ERROR'}`, j.ok ? 'ok' : 'err');
      } catch (e) {
        addLog('Health check error: ' + e.message, 'err');
      }
    };
  </script>
</body>
</html>
