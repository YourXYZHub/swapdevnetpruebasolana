<!DOCTYPE html>
<html>
<head>
  <title>Swap DBC & DAMM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
    .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
    .tab button:hover { background-color: #ddd; }
    .tab button.active { background-color: #ccc; }
    .tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; border-top: none; }
    input, button { margin: 5px; padding: 8px; width: 300px; }
    .log { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
  </style>
</head>
<body>
  <h1>Swap DBC & DAMM Devnet</h1>

  <div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'DBC')">DBC Swap</button>
    <button class="tablinks" onclick="openTab(event, 'DAMM')">DAMM Swap</button>
  </div>

  <!-- DBC Tab -->
  <div id="DBC" class="tabcontent" style="display: block;">
    <h3>DBC Swap (SOL ↔ TOKEN)</h3>
    
    <div>
      <input type="text" id="dbcPool" placeholder="Pool Address" />
      <input type="number" id="dbcAmount" placeholder="Amount" step="0.0001" />
      <select id="dbcAction">
        <option value="buy">BUY (SOL → TOKEN)</option>
        <option value="sell">SELL (TOKEN → SOL)</option>
      </select>
      <button onclick="dbcSwap()">Execute DBC Swap</button>
    </div>
  </div>

  <!-- DAMM Tab -->
  <div id="DAMM" class="tabcontent">
    <h3>DAMM Swap (Any Token Pair)</h3>
    
    <div>
      <input type="text" id="dammPool" placeholder="Pool Address" />
      <input type="text" id="inputMint" placeholder="Input Mint" />
      <input type="text" id="outputMint" placeholder="Output Mint" />
      <input type="number" id="dammAmount" placeholder="Amount" />
      <button onclick="dammSwap()">Execute DAMM Swap</button>
    </div>
  </div>

  <!-- Common Controls -->
  <div>
    <h3>Wallet</h3>
    <button onclick="connectWallet()">Connect Wallet</button>
    <div id="walletInfo"></div>
  </div>

  <h3>Transaction Log</h3>
  <div id="log" class="log"></div>

  <script>
    const BACKEND_URL = "https://tu-backend.railway.app";
    let wallet = null;
    let connection = null;

    // Utility functions
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
      logDiv.innerHTML = `<span style="color: ${color}">[${timestamp}] ${message}</span><br>` + logDiv.innerHTML;
    }

    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    // Wallet connection
    async function connectWallet() {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          throw new Error('Phantom wallet not found');
        }

        const provider = window.solana;
        const response = await provider.connect();
        wallet = response.publicKey.toString();
        
        document.getElementById('walletInfo').innerHTML = `Connected: ${wallet}`;
        log('Wallet connected successfully', 'success');
        
        // Switch to devnet
        try {
          await provider.request({ method: 'wallet_switchSolanaNetwork', params: { network: 'devnet' } });
        } catch (e) {
          log('Could not switch to devnet: ' + e.message);
        }
        
      } catch (error) {
        log('Wallet connection failed: ' + error.message, 'error');
      }
    }

    // DBC Swap
    async function dbcSwap() {
      if (!wallet) {
        log('Please connect wallet first', 'error');
        return;
      }

      try {
        const pool = document.getElementById('dbcPool').value;
        const amount = document.getElementById('dbcAmount').value;
        const action = document.getElementById('dbcAction').value;

        if (!pool || !amount) {
          log('Please fill all fields', 'error');
          return;
        }

        log(`Building DBC ${action} transaction...`);

        const response = await fetch(`${BACKEND_URL}/dbc/${action}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pool,
            [action === 'buy' ? 'buyer' : 'seller']: wallet,
            [action === 'buy' ? 'amountSol' : 'amountTokens']: amount
          })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Transaction build failed');
        }

        log('Transaction built, signing...');

        // Send transaction
        await sendTransaction(data.transaction);

      } catch (error) {
        log('DBC swap failed: ' + error.message, 'error');
      }
    }

    // DAMM Swap
    async function dammSwap() {
      if (!wallet) {
        log('Please connect wallet first', 'error');
        return;
      }

      try {
        const pool = document.getElementById('dammPool').value;
        const inputMint = document.getElementById('inputMint').value;
        const outputMint = document.getElementById('outputMint').value;
        const amount = document.getElementById('dammAmount').value;

        if (!pool || !inputMint || !outputMint || !amount) {
          log('Please fill all fields', 'error');
          return;
        }

        log('Building DAMM swap transaction...');

        const response = await fetch(`${BACKEND_URL}/damm/swap`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pool,
            user: wallet,
            inputMint,
            outputMint,
            amount
          })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Transaction build failed');
        }

        log('Transaction built, signing...');
        await sendTransaction(data.transaction);

      } catch (error) {
        log('DAMM swap failed: ' + error.message, 'error');
      }
    }

    // Generic transaction sender
    async function sendTransaction(transactionBase64) {
      try {
        const provider = window.solana;
        const rawTransaction = Uint8Array.from(atob(transactionBase64), c => c.charCodeAt(0));

        let transaction;
        try {
          transaction = solanaWeb3.VersionedTransaction.deserialize(rawTransaction);
          log('Versioned transaction deserialized');
        } catch {
          transaction = solanaWeb3.Transaction.from(rawTransaction);
          log('Legacy transaction deserialized');
        }

        // Try signAndSendTransaction first
        try {
          const signature = await provider.signAndSendTransaction(transaction);
          log(`Transaction sent: ${signature}`, 'success');
          await confirmTransaction(signature);
        } catch (error) {
          log('signAndSend failed, trying fallback: ' + error.message);
          
          // Fallback: sign manually
          const signed = await provider.signTransaction(transaction);
          const serialized = signed.serialize();
          const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
          const signature = await connection.sendRawTransaction(serialized);
          log(`Transaction sent (fallback): ${signature}`, 'success');
          await confirmTransaction(signature);
        }

      } catch (error) {
        throw new Error('Transaction failed: ' + error.message);
      }
    }

    async function confirmTransaction(signature) {
      const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
      const confirmation = await connection.confirmTransaction(signature, 'confirmed');
      
      if (confirmation.value.err) {
        throw new Error('Transaction confirmation failed');
      }
      
      log(`Transaction confirmed: https://solscan.io/tx/${signature}?cluster=devnet`, 'success');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (window.solana) {
        log('Phantom wallet detected');
        window.solana.on('connect', () => {
          wallet = window.solana.publicKey.toString();
          document.getElementById('walletInfo').innerHTML = `Connected: ${wallet}`;
        });
      } else {
        log('Phantom wallet not found', 'error');
      }
    });
  </script>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
</body>
</html>
